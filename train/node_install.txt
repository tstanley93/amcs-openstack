### Create External Networks
openstack network create storagenet --external --provider-network-type vlan --provider-physical-network float --share --provider-segment 12
openstack network create storagemgmtnet --external --provider-network-type vlan --provider-physical-network float --share --provider-segment 93
openstack network create internalapinet --external --provider-network-type vlan --provider-physical-network float --share --provider-segment 94
openstack network create tenantnet --external --provider-network-type vlan --provider-physical-network float --share --provider-segment 95

### Create External Subnets
openstack subnet create storagenet --network storagenet --subnet-range 10.12.0.0/24 --dhcp --allocation-pool start=10.12.0.70,end=10.12.0.99
openstack subnet create storagemgmtnet --network storagemgmtnet --subnet-range 10.94.0.0/16 --dhcp --allocation-pool start=10.94.1.100,end=10.94.1.200
openstack subnet create internalapinet --network internalapinet --subnet-range 10.92.0.0/16 --dhcp --allocation-pool start=10.92.1.100,end=10.92.1.200
openstack subnet create tenantnet --network tenantnet --subnet-range 10.95.0.0/16 --dhcp --allocation-pool start=10.95.1.100,end=10.95.1.200

### osdir Port Create
openstack port create --network mgmt_ts osdir-mgmt
openstack port create --network pgw_ex osdir-pgw_ex
openstack port create --network pgw_ex osdir-admin
openstack port create --network pgw_ex osdir-vip
openstack port set --allowed-address ip-address=0.0.0.0/0 osdir-pgw_ex

### virtcompute1 Port Create
openstack port create --network pgw_ex virtcompute1-pgw_ex
openstack port create --network storagenet virtcompute1-storagenet
openstack port create --network internalapinet virtcompute1-storagenet
openstack port create --network tenantnet virtcompute1-tenantnet
openstack port create --network public virtcompute1-public
openstack port set --allowed-address ip-address=0.0.0.0/0 virtcompute1-storagenet
openstack port set --allowed-address ip-address=0.0.0.0/0 virtcompute1-storagenet
openstack port set --allowed-address ip-address=0.0.0.0/0 virtcompute1-tenantnet
openstack port set --allowed-address ip-address=0.0.0.0/0 virtcompute1-public

### controller1 Port Create
openstack port create --network pgw_ex controller1-pgw_ex
openstack port create --network storagenet controller1-storagenet
openstack port create --network storagemgmtnet controller1-storagemgmtnet
openstack port create --network internalapinet controller1-internalapinet
openstack port create --network tenantnet controller1-tenantnet
openstack port create --network public controller1-public
openstack port set --allowed-address ip-address=0.0.0.0/0 controller1-storagenet
openstack port set --allowed-address ip-address=0.0.0.0/0 controller1-storagemgmtnet
openstack port set --allowed-address ip-address=0.0.0.0/0 controller1-internalapinet
openstack port set --allowed-address ip-address=0.0.0.0/0 controller1-tenantnet
openstack port set --allowed-address ip-address=0.0.0.0/0 controller1-public

### controller2 Port Create
openstack port create --network pgw_ex controller2-pgw_ex
openstack port create --network storagenet controller2-storagenet
openstack port create --network storagemgmtnet controller2-storagemgmtnet
openstack port create --network internalapinet controller2-internalapinet
openstack port create --network tenantnet controller2-tenantnet
openstack port create --network public controller2-public
openstack port set --allowed-address ip-address=0.0.0.0/0 controller2-storagenet
openstack port set --allowed-address ip-address=0.0.0.0/0 controller2-storagemgmtnet
openstack port set --allowed-address ip-address=0.0.0.0/0 controller2-internalapinet
openstack port set --allowed-address ip-address=0.0.0.0/0 controller2-tenantnet
openstack port set --allowed-address ip-address=0.0.0.0/0 controller2-public

### controller3 Port Create
openstack port create --network pgw_ex controller3-pgw_ex
openstack port create --network storagenet controller3-storagenet
openstack port create --network storagemgmtnet controller3-storagemgmtnet
openstack port create --network internalapinet controller3-internalapinet
openstack port create --network tenantnet controller3-tenantnet
openstack port create --network public controller3-public
openstack port set --allowed-address ip-address=0.0.0.0/0 controller3-storagenet
openstack port set --allowed-address ip-address=0.0.0.0/0 controller3-storagemgmtnet
openstack port set --allowed-address ip-address=0.0.0.0/0 controller3-internalapinet
openstack port set --allowed-address ip-address=0.0.0.0/0 controller3-tenantnet
openstack port set --allowed-address ip-address=0.0.0.0/0 controller3-public

### VIP Port Create
openstack port create --network storagenet storagevipport
openstack port create --network storagemgmtnet storagemgmtvipport
openstack port create --network internalapinet internalapivipport
openstack port create --network public publicvipport



### Create Servers

openstack server create \
--key-name stanley01 \
--image "CentOS-Stream-ec2-8-20210210.0.x86_64" \
--flavor m1.xlarge \
--nic port-id=d88a42be-613f-4612-8391-5d736f4bd81c \
--nic port-id=64f63299-dcc7-4f91-81e3-3a44e215713f \
osdir

openstack server create \
--key-name stanley01 \
--image "openstack_16_image_5" \
--flavor m1.large \
--nic port-id=4addab8f-7521-4a98-b160-bf3a9c19547a \
--nic port-id=aa99a0ae-f958-4485-a785-21d1ce56981f \
--nic port-id=af826860-b9d2-4fd4-9c0f-c2cbf42336c2 \
--nic port-id=bb5ecf4c-768f-42af-b1af-0c569330e23f \
--nic port-id=320e6d38-aced-4eca-b764-65755021dc5b \
--nic port-id=6833347b-5b82-4c6e-a62f-939b89ab6626 \
controller1

openstack server create \
--key-name stanley01 \
--image "openstack_16_image_5" \
--flavor m1.large \
--nic port-id=ce9b28c0-62ed-492f-8a00-383e77146ab8 \
--nic port-id=eedfe918-f56b-4157-988c-8cac17197d07 \
--nic port-id=a16bf007-6f3f-431c-9f5a-e1cbc673ffa9 \
--nic port-id=5254257c-a1d5-4eaf-af1c-6c5d60c55623 \
--nic port-id=9af2f183-8335-4db3-9fc1-d1c96cdc235f \
--nic port-id=847c2aca-004c-495b-83e7-0c286d3e9a9d \
controller2

openstack server create \
--key-name stanley01 \
--image "openstack_16_image_5" \
--flavor m1.large \
--nic port-id=92bafb7c-1bb0-4a27-b5c2-e78365b3972a \
--nic port-id=f75c0af7-caad-4586-a6b5-0b18c5056fe1 \
--nic port-id=185d3236-4a08-4b51-bb3c-1d63a7917f52 \
--nic port-id=3ec0d822-4ab6-478e-957d-4ecad3650de9 \
--nic port-id=45b1fe0c-49bd-4fd1-a45c-cbd2e75fce91 \
--nic port-id=be606b62-daf7-4b93-b02c-93d90f2676f9 \
controller3

openstack server create \
--key-name stanley01 \
--image "openstack_16_image_5" \
--flavor m1.large \
--nic port-id=f7c7ad00-2a3f-49c1-923a-4334ac0f380f \
--nic port-id=dbc8984a-2652-4be5-b282-94d887a4810e \
--nic port-id=f51afcc4-ee4e-4678-b4be-659df0d45b20 \
--nic port-id=94d1e07b-3d0b-4c40-b6b3-2f7c23caa791 \
--nic port-id=3926c9fa-7770-4ab1-8f3a-12279b779c62 \
virtcompute1

#### Install Software
sudo su -
echo "stack ALL=(root) NOPASSWD:ALL" | tee -a /etc/sudoers.d/stack
chmod 0440 /etc/sudoers.d/stack
exit
sudo yum -y update
sudo yum install -y epel-release
sudo yum install -y git tcpdump open-vm-tools rsyslog
sudo yum remove -y epel-release
sudo dnf install -y https://trunk.rdoproject.org/centos8/component/tripleo/current/python3-tripleo-repos-0.1.1-0.20210714130758.06f41a6.el8.noarch.rpm
sudo -E tripleo-repos -b train current --no-stream
sudo yum install -y python3-tripleoclient (For Undercloud Nodes)
or...
sudo yum install -y python3-heat-agent*  (For Overcloud Nodes)
sudo reboot

openstack tripleo container image prepare default \
  --local-push-destination \
  --output-env-file ~/containers-prepare-parameter.yaml

git clone https://github.com/tstanley93/amcs-openstack.git
cd ~/amcs-openstack/
git checkout train-home
cd ~
ln -s /home/stack/amcs-openstack/train/undercloud_home.conf ~/undercloud.conf
ln -s /home/stack/amcs-openstack/train/ ~/templates

openstack undercloud install 

#####  Add Stack User
sudo useradd stack
sudo passwd stack  # specify a password
echo "stack ALL=(root) NOPASSWD:ALL" | sudo tee -a /etc/sudoers.d/stack
sudo chmod 0440 /etc/sudoers.d/stack
sudo vi /etc/ssh/sshd_config
change PasswordAuthentication to yes
change GSSAPIAuthentication to no
sudo systemctl restart sshd.service
exit

### Back on Director
ssh-copy-id stack@192.168.24.2

### Back to Node
sudo vi /etc/ssh/sshd_config
comment PasswordAuthentication yes
uncomment PasswordAuthentication no
:wq
sudo systemctl restart sshd.service

### Removed extra NIC config
sudo rm /etc/sysconfig/network-scripts/ifcfg-ens*
sudo systemctl restart network.service	

### Node Ready
exit

#####################################################################
### After Creating the Node  ########################################
#####################################################################
echo "" > .ssh/known_hosts

echo "osdir" | sudo tee /etc/hostname
sudo sed -e 's/domain4/domain4 osdir/' -i /etc/hosts
sudo sed -e 's/domain6/domain6 osdir/' -i /etc/hosts
echo "network: {config: disabled}" | sudo tee -a /etc/cloud/cloud.cfg.d/99-custom-networking.cfg
sudo sed -e 's/no/yes/' -i /etc/sysconfig/network-scripts/ifcfg-eth0
sudo sed -e 's/dhcp/none/' -i /etc/sysconfig/network-scripts/ifcfg-eth0
echo "DNS1=172.27.1.1" | sudo tee -a /etc/sysconfig/network-scripts/ifcfg-eth0
echo "DNS2=172.27.2.1" | sudo tee -a /etc/sysconfig/network-scripts/ifcfg-eth0
echo "IPADDR=10.10.6.10" | sudo tee -a /etc/sysconfig/network-scripts/ifcfg-eth0
echo "NETMASK=255.255.254.0" | sudo tee -a /etc/sysconfig/network-scripts/ifcfg-eth0
echo "GATEWAY=10.10.6.25" | sudo tee -a /etc/sysconfig/network-scripts/ifcfg-eth0
sudo reboot
#####################################################################
